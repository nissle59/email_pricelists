from typing import Self, TYPE_CHECKING
import ttkbootstrap as ttk
from ttkbootstrap.constants import *
from ttkbootstrap.toast import ToastNotification
from ttkbootstrap.scrolled import ScrolledFrame
import json

from ui.parser_config_dialog import ParserConfigWindow

if TYPE_CHECKING:
    from ui.gui import App


class EmailSettingsFrame(ttk.Frame):
    def __init__(self, parent):
        super().__init__(parent)
        self.pack(fill=BOTH, expand=YES, padx=10, pady=10)
        self._create_widgets()

    def _create_widgets(self):
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        ttk.Label(
            self,
            text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–æ—á—Ç–µ",
            font=("Helvetica", 14, "bold")
        ).pack(anchor=W, pady=(0, 15))

        # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container = ttk.Frame(self)
        container.pack(fill=X, padx=5)

        # –õ–æ–≥–∏–Ω (email)
        ttk.Label(container, text="–õ–æ–≥–∏–Ω (email):", width=20).grid(row=0, column=0, sticky=W, pady=5)
        self.email_var = ttk.StringVar(value="")
        email_entry = ttk.Entry(container, textvariable=self.email_var, width=30)
        email_entry.grid(row=0, column=1, sticky=W, pady=5, padx=(0, 10))

        # –ü–∞—Ä–æ–ª—å
        ttk.Label(container, text="–ü–∞—Ä–æ–ª—å:", width=20).grid(row=1, column=0, sticky=W, pady=5)
        self.password_var = ttk.StringVar(value="")
        password_entry = ttk.Entry(container, textvariable=self.password_var, show="*", width=30)
        password_entry.grid(row=1, column=1, sticky=W, pady=5, padx=(0, 10))

        # IMAP —Å–µ—Ä–≤–µ—Ä
        ttk.Label(container, text="IMAP —Å–µ—Ä–≤–µ—Ä:", width=20).grid(row=2, column=0, sticky=W, pady=5)
        self.imap_var = ttk.StringVar(value="imap.yandex.ru")
        imap_entry = ttk.Entry(container, textvariable=self.imap_var, width=30)
        imap_entry.grid(row=2, column=1, sticky=W, pady=5, padx=(0, 10))

        # –ü–æ—Ä—Ç
        ttk.Label(container, text="–ü–æ—Ä—Ç:", width=20).grid(row=3, column=0, sticky=W, pady=5)
        self.port_var = ttk.StringVar(value="993")
        port_entry = ttk.Entry(container, textvariable=self.port_var, width=30)
        port_entry.grid(row=3, column=1, sticky=W, pady=5, padx=(0, 10))

        # –ö–Ω–æ–ø–∫–∏
        btn_frame = ttk.Frame(container)
        btn_frame.grid(row=4, column=0, columnspan=2, pady=15, sticky=W)

        ttk.Button(
            btn_frame,
            text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
            bootstyle=SUCCESS,
            command=self._save_email_settings
        ).pack(side=LEFT, padx=(0, 10))

        ttk.Button(
            btn_frame,
            text="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ",
            bootstyle=INFO,
            command=self._test_connection
        ).pack(side=LEFT)

    def _save_email_settings(self):
        settings = {
            'email': self.email_var.get(),
            'imap_server': self.imap_var.get(),
            'port': self.port_var.get()
        }
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –∏–ª–∏ —Ñ–∞–π–ª
        ToastNotification(
            title="–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ",
            message="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—á—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã",
            bootstyle=SUCCESS
        ).show_toast()

    def _test_connection(self):
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        ToastNotification(
            title="–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è",
            message="–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ",
            bootstyle=INFO
        ).show_toast()


class FilterRuleFrame(ttk.Frame):
    def __init__(self, parent, rule_data=None):
        super().__init__(parent)
        self.rule_data = rule_data or {}
        self._create_widgets()

    def _create_widgets(self):
        # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤–∏–ª–∞
        main_frame = ttk.Frame(self)
        main_frame.pack(fill=X, pady=5)

        # Email –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        ttk.Label(main_frame, text="Email –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:", width=15).grid(row=0, column=0, sticky=W, pady=2)
        self.sender_var = ttk.StringVar(value=self.rule_data.get('sender', ''))
        sender_entry = ttk.Entry(main_frame, textvariable=self.sender_var, width=25)
        sender_entry.grid(row=0, column=1, sticky=W, pady=2, padx=5)

        # –£—Å–ª–æ–≤–∏—è –¥–ª—è —Ç–µ–º—ã
        ttk.Label(main_frame, text="–¢–µ–º–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç:", width=15).grid(row=1, column=0, sticky=W, pady=2)
        self.subject_var = ttk.StringVar(value=self.rule_data.get('subject_contains', ''))
        subject_entry = ttk.Entry(main_frame, textvariable=self.subject_var, width=25)
        subject_entry.grid(row=1, column=1, sticky=W, pady=2, padx=5)

        # –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
        ttk.Label(main_frame, text="–†–∞—Å—à–∏—Ä–µ–Ω–∏—è:", width=15).grid(row=2, column=0, sticky=W, pady=2)
        self.extensions_var = ttk.StringVar(value=self.rule_data.get('extensions', '.xlsx,.xls,.xlsm'))
        extensions_entry = ttk.Entry(main_frame, textvariable=self.extensions_var, width=25)
        extensions_entry.grid(row=2, column=1, sticky=W, pady=2, padx=5)

        # –ò–º—è —Ñ–∞–π–ª–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç
        ttk.Label(main_frame, text="–ò–º—è —Ñ–∞–π–ª–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç:", width=15).grid(row=3, column=0, sticky=W, pady=2)
        self.filename_contains_var = ttk.StringVar(value=self.rule_data.get('filename_contains', ''))
        filename_entry = ttk.Entry(main_frame, textvariable=self.filename_contains_var, width=25)
        filename_entry.grid(row=3, column=1, sticky=W, pady=2, padx=5)

        # –ò–º—è —Ñ–∞–π–ª–∞ –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç
        ttk.Label(main_frame, text="–ò–º—è —Ñ–∞–π–ª–∞ –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç:", width=15).grid(row=4, column=0, sticky=W, pady=2)
        self.filename_excludes_var = ttk.StringVar(value=self.rule_data.get('filename_excludes', ''))
        filename_ex_entry = ttk.Entry(main_frame, textvariable=self.filename_excludes_var, width=25)
        filename_ex_entry.grid(row=4, column=1, sticky=W, pady=2, padx=5)

        # –ü—Ä–∏–Ω–∏–º–∞—Ç—å –≤—Å–µ –≤–ª–æ–∂–µ–Ω–∏—è
        self.accept_all_var = ttk.BooleanVar(value=self.rule_data.get('accept_all', False))
        accept_all_cb = ttk.Checkbutton(
            main_frame,
            text="–ü—Ä–∏–Ω–∏–º–∞—Ç—å –≤—Å–µ –≤–ª–æ–∂–µ–Ω–∏—è (–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã)",
            variable=self.accept_all_var,
            command=self._toggle_filters
        )
        accept_all_cb.grid(row=5, column=0, columnspan=2, sticky=W, pady=5)

        # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è
        btn_frame = ttk.Frame(main_frame)
        btn_frame.grid(row=6, column=0, columnspan=2, pady=5, sticky=W)

        ttk.Button(
            btn_frame,
            text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞",
            bootstyle=SECONDARY,
            command=self._configure_parser
        ).pack(side=LEFT, padx=(0, 10))

        ttk.Button(
            btn_frame,
            text="–£–¥–∞–ª–∏—Ç—å",
            bootstyle=DANGER,
            command=self._delete_rule
        ).pack(side=LEFT)

        self._toggle_filters()

    def _toggle_filters(self):
        state = NORMAL if not self.accept_all_var.get() else DISABLED
        widgets = [
            self.subject_var, self.extensions_var,
            self.filename_contains_var, self.filename_excludes_var
        ]
        # –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤–∏–¥–∂–µ—Ç—ã
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–∂–µ—Ç—ã Entry

    def _configure_parser(self):
        """–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –ø–∞—Ä—Å–µ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞"""
        sender_email = self.sender_var.get()
        if not sender_email:
            ToastNotification(
                title="–û—à–∏–±–∫–∞",
                message="–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ email –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è",
                bootstyle=DANGER
            ).show_toast()
            return

        # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
        rule_data = {
            'sender': sender_email,
            'subject_contains': self.subject_var.get(),
            'extensions': self.extensions_var.get(),
            'filename_contains': self.filename_contains_var.get(),
            'filename_excludes': self.filename_excludes_var.get(),
            'accept_all': self.accept_all_var.get()
        }

        print(f"–û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –¥–ª—è: {sender_email}")  # –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

        # –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
        config_window = ParserConfigWindow(self, sender_email, rule_data)

        # –î–µ–ª–∞–µ–º –æ–∫–Ω–æ –º–æ–¥–∞–ª—å–Ω—ã–º
        config_window.transient(self)
        config_window.grab_set()
        self.wait_window(config_window)

    def _delete_rule(self):
        # –£–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
        self.destroy()


class FilterSettingsFrame(ttk.Frame):
    def __init__(self, parent):
        super().__init__(parent)
        self.pack(fill=BOTH, expand=YES, padx=10, pady=10)
        self.filter_rules = []
        self._create_widgets()
        self._load_default_rules()

    def _create_widgets(self):
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        header_frame = ttk.Frame(self)
        header_frame.pack(fill=X, pady=(0, 15))

        ttk.Label(
            header_frame,
            text="–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –ø–∏—Å–µ–º",
            font=("Helvetica", 14, "bold")
        ).pack(side=LEFT, anchor=W)

        ttk.Button(
            header_frame,
            text="+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ",
            bootstyle=SUCCESS,
            command=self._add_new_rule
        ).pack(side=RIGHT)

        # –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å –¥–ª—è –ø—Ä–∞–≤–∏–ª
        self.scrolled_frame = ScrolledFrame(self, height=400)
        self.scrolled_frame.pack(fill=BOTH, expand=YES)

    def _load_default_rules(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã –±–æ–µ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª"""
        default_rules = [
            {
                'sender': 'kormiltsev@technosite.ru',
                'extensions': '.xlsx',
                'filename_excludes': '–≤–Ω–µ—à–Ω–∏–π –∑–∞–∫–∞–∑',
                'subject_contains': '–ø—Ä–∞–π—Å'
            },
            {
                'sender': 'khanova@technosite.ru',
                'subject_contains': '–ø—Ä–∞–π—Å',
                'extensions': '.xlsx,.xls,.xlsm'
            },
            {
                'sender': 'jtc2@autoopt.ru',
                'subject_contains': '–ø—Ä–∞–π—Å –ª–∏—Å—Ç',
                'extensions': '.xlsx,.xls,.xlsm'
            },
            {
                'sender': 'E.Maltseva@igr.ru',
                'extensions': '.xlsx,.xls,.xlsm',
                'accept_all': True
            },
            {
                'sender': 'Kadyrmaeva@toys.inventive.ru',
                'subject_contains': '–ø—Ä–∞–π—Å,–Ω–æ–≤–∏–Ω–∫–∏,–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
                'extensions': '.xlsm,.xls,.xlsx'
            },
            {
                'sender': 'order@mactak.ru',
                'subject_contains': '–ø—Ä–∞–π—Å-–ª–∏—Å—Ç',
                'extensions': '.xlsx,.xls,.xlsm'
            },
            {
                'sender': '1c_mail@1toys.ru',
                'accept_all': True
            },
            {
                'sender': 'sale@megalight.ru',
                'accept_all': True
            }
        ]

        for rule_data in default_rules:
            self._add_rule_frame(rule_data)

    def _add_new_rule(self):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ –ø—É—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ"""
        self._add_rule_frame({})

    def _add_rule_frame(self, rule_data):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ—Ä–µ–π–º –ø—Ä–∞–≤–∏–ª–∞ –≤ —Å–ø–∏—Å–æ–∫"""
        rule_frame = FilterRuleFrame(self.scrolled_frame, rule_data)
        rule_frame.pack(fill=X, pady=5, padx=5)
        self.filter_rules.append(rule_frame)

        # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        separator = ttk.Separator(self.scrolled_frame, orient=HORIZONTAL)
        separator.pack(fill=X, pady=2)

    def save_filters(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã"""
        filters_data = []
        for rule_frame in self.filter_rules:
            if rule_frame.winfo_exists():  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—Ä–µ–π–º –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                rule_data = {
                    'sender': rule_frame.sender_var.get(),
                    'subject_contains': rule_frame.subject_var.get(),
                    'extensions': rule_frame.extensions_var.get(),
                    'filename_contains': rule_frame.filename_contains_var.get(),
                    'filename_excludes': rule_frame.filename_excludes_var.get(),
                    'accept_all': rule_frame.accept_all_var.get()
                }
                filters_data.append(rule_data)

        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
        ToastNotification(
            title="–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ",
            message=f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(filters_data)} –ø—Ä–∞–≤–∏–ª —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏",
            bootstyle=SUCCESS
        ).show_toast()


def launch_price_parser():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–∞—Ä—Å–µ—Ä –≤ –¥–æ—á–µ—Ä–Ω–µ–º –æ–∫–Ω–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç–∏–ª–µ–π"""
    from parser import PriceParserApp
    ToastNotification(
        title="–ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞",
        message="–ü–∞—Ä—Å–µ—Ä —Ü–µ–Ω –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...",
        duration=2000
    ).show_toast()
    ps = PriceParserApp(parent=ttk.Toplevel(title="–ü–∞—Ä—Å–µ—Ä —Ü–µ–Ω"))


def create_settings_frame(self, notebook):
    tab_settings = ttk.Frame(notebook)
    notebook.add(tab_settings, text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")

    # –°–æ–∑–¥–∞–µ–º Notebook –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    settings_notebook = ttk.Notebook(tab_settings)
    settings_notebook.pack(fill=BOTH, expand=YES, padx=10, pady=10)

    # –í–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ—á—Ç—ã
    email_tab = ttk.Frame(settings_notebook)
    settings_notebook.add(email_tab, text="üìß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—á—Ç—ã")
    EmailSettingsFrame(email_tab)

    # –í–∫–ª–∞–¥–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    filter_tab = ttk.Frame(settings_notebook)
    settings_notebook.add(filter_tab, text="üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–∏—Å–µ–º")
    filter_frame = FilterSettingsFrame(filter_tab)

    # –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    bottom_frame = ttk.Frame(tab_settings)
    bottom_frame.pack(fill=X, padx=10, pady=10)

    ttk.Button(
        bottom_frame,
        text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
        bootstyle=SUCCESS,
        command=filter_frame.save_filters
    ).pack(side=RIGHT, padx=(10, 0))

    ttk.Button(
        bottom_frame,
        text="–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–µ—Ä",
        bootstyle=PRIMARY,
        command=launch_price_parser
    ).pack(side=RIGHT)